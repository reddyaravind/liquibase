name: Liquibase CI/CD Pipeline

on:
  workflow_dispatch: # Allows manual triggering of the pipeline

jobs:
  liquibase-cicd:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # Set Timestamp for unique filename
    - name: Set Timestamp
      id: timestamp
      run: echo "TIMESTAMP=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

    # Generate Diff ChangeLog with Timestamp
    - name: Run Liquibase to Generate Diff ChangeLog
      run: |
        # Create changelog directory inside the workspace
        mkdir -p ${{ github.workspace }}/changelog
        echo "Working directory: ${{ github.workspace }}/changelog"
        
        # Run liquibase to generate the diff changelog and map the workspace directory
        docker run --rm \
          -v ${{ github.workspace }}/changelog:/liquibase/changelog \
          liquibase/liquibase \
          --referenceUrl="jdbc:postgresql://junction.proxy.rlwy.net:38704/railway" \
          --referenceUsername="postgres" \
          --referencePassword="PZTcUieBZVvBuxkxfQJSRMeUFXZmdLFN" \
          --url="jdbc:postgresql://junction.proxy.rlwy.net:33223/railway" \
          --username="postgres" \
          --password="oPgUTipUBnhQBqbWnRYpeaKCdNJKMXQp" \
          --changeLogFile="/liquibase/changelog/changelog_diff_${{ env.TIMESTAMP }}.xml" \
          diffChangeLog

        # List files in changelog directory
        echo "Listing files in changelog directory:"
        ls -l ${{ github.workspace }}/changelog

    # Verify changelog file existence
    - name: Verify Changelog File
      run: |
        echo "Checking if changelog file exists in the directory"
        if [ -f ${{ github.workspace }}/changelog/changelog_diff_${{ env.TIMESTAMP }}.xml ]; then
          echo "Changelog file created successfully!"
        else
          echo "Changelog file was not created!"
        fi

    # Apply changes to production using the changelog file
    - name: Apply Changes to Production
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/changelog:/liquibase/changelog \
          liquibase/liquibase \
          --url="jdbc:postgresql://junction.proxy.rlwy.net:33223/railway" \
          --username="postgres" \
          --password="oPgUTipUBnhQBqbWnRYpeaKCdNJKMXQp" \
          --changeLogFile="changelog/changelog_diff_${{ env.TIMESTAMP }}.xml" \
          update
        echo "Changes applied successfully to production!"

    # Generate a new changelog file from the production DB
    - name: Generate New Changelog from Production DB
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/changelog:/liquibase/changelog \
          liquibase/liquibase \
          --url="jdbc:postgresql://junction.proxy.rlwy.net:18143/railway" \
          --username="postgres" \
          --password="mETBgLqbGkxManJuOUtqRbdyZQmpRacV" \
          --changeLogFile="/liquibase/changelog/changelog_prod_generated_${{ env.TIMESTAMP }}.xml" \
          generateChangeLog

    # Push the updated production changelog to GitHub
    - name: Push Updated Production Changelog to GitHub
      run: |
        git config --global user.name "reddyaravind"
        git config --global user.email "reddyaravind838@gmail.com"
        git add changelog/changelog_prod_generated_${{ env.TIMESTAMP }}.xml
        git commit -m "Updated production changelog"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
